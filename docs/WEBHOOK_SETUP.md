# Настройка Webhook для Telegram бота

## Обзор

Этот проект настроен для работы с Telegram Bot API через webhook на порту 8080. Сервер предоставляет следующие эндпоинты:

- `/healthz` - проверка состояния сервера
- `/webhook` - эндпоинт для получения обновлений от Telegram

## Конфигурация

### Переменные окружения

Создайте файл `.env` со следующими переменными:

```env
# Обязательные
TELEGRAM_BOT_TOKEN=your_bot_token_here
WEBHOOK_URL=https://your-domain.com

# Опциональные
PORT=8080
LOG_LEVEL=info
HTTP_TIMEOUT=30
MAX_RETRIES=3
```

### Настройка Fly.io

Файл `fly.toml` уже настроен для:
- Публикации порта 8080
- Health check на `/healthz`
- HTTPS принудительно включен
- Автоматический старт/стоп машин

## Запуск

### Локальная разработка

1. Установите зависимости:
```bash
go mod tidy
```

2. Создайте `.env` файл с вашими настройками

3. Запустите сервер:
```bash
go run .
```

4. Для тестирования webhook локально используйте ngrok:
```bash
ngrok http 8080
```

5. Установите `WEBHOOK_URL` на полученный ngrok URL

### Продакшн (Fly.io)

1. Разверните на Fly.io:
```bash
fly deploy
```

2. Установите секреты:
```bash
fly secrets set TELEGRAM_BOT_TOKEN=your_bot_token
fly secrets set WEBHOOK_URL=https://your-app.fly.dev
```

## Тестирование

### Тест HTTP сервера

Запустите тестовый скрипт:

```bash
go run cmd/test_server/main.go
```

Этот скрипт проверит:
- Доступность `/healthz`
- Правильную обработку GET запросов к `/webhook`
- Обработку POST запросов к `/webhook`

### Проверка webhook

1. Убедитесь, что сервер запущен
2. Отправьте сообщение боту в Telegram
3. Проверьте логи сервера на наличие webhook запросов

## Безопасность

### Секретный токен

Сервер автоматически генерирует секретный токен для webhook и проверяет его в заголовке `X-Telegram-Bot-Api-Secret-Token`. Это обеспечивает дополнительную безопасность.

### HTTPS

В продакшне всегда используйте HTTPS URL для webhook. Fly.io автоматически предоставляет SSL сертификаты.

## Мониторинг

### Health Check

Эндпоинт `/healthz` возвращает JSON с информацией о состоянии сервера:

```json
{
  "status": "healthy",
  "webhook": "https://your-domain.com/webhook",
  "port": "8080"
}
```

### Логирование

Сервер использует структурированное логирование с различными уровнями:
- `debug` - детальная отладочная информация
- `info` - основная информация о работе
- `warn` - предупреждения
- `error` - ошибки

## Устранение неполадок

### Webhook не устанавливается

1. Проверьте, что `WEBHOOK_URL` начинается с `https://`
2. Убедитесь, что сервер доступен из интернета
3. Проверьте логи на наличие ошибок

### Сообщения не обрабатываются

1. Проверьте, что webhook установлен: `curl https://api.telegram.org/bot<TOKEN>/getWebhookInfo`
2. Убедитесь, что секретный токен правильно передается
3. Проверьте логи сервера

### Health check не проходит

1. Убедитесь, что сервер запущен на порту 8080
2. Проверьте, что эндпоинт `/healthz` доступен
3. Проверьте конфигурацию в `fly.toml`

## Структура проекта

```
.
├── main.go              # Основная точка входа
├── webhook.go           # Webhook сервер
├── config.go            # Конфигурация
├── fly.toml            # Конфигурация Fly.io
├── cmd/
│   └── test_server/    # Тестовый клиент
└── WEBHOOK_SETUP.md    # Эта документация
```
